name: Cypress Test

on:
  pull_request:
  workflow_dispatch:

jobs:
  ci:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - uses: Azure/login@v1
        with:
          creds: ${{ secrets.AZURE_DEV_CREDENTIALS }}

      - uses: Azure/get-keyvault-secrets@v1
        with:
          keyvault: ${{ secrets.AZURE_KEYVAULT_DEV_NAME }}
          secrets: 'MockUserNonProdWeb, AzureAdClientIdScope'  # comma separated list of secret keys that need to be fetched from the Key Vault 
        id: keyVaultSecrets

      - name: build
        working-directory: GetAccessToken
        run: dotnet build --configuration Release

      - name: Put access token in key vault
        env:
          buildConfiguration: 'Release'
          mockuserAppId: ${{ secrets.MOCK_USER_DEV_CLIENT_SECRET }}
          mockappuserClientSecret: ${{ steps.keyVaultSecrets.outputs.MockUserNonProdWeb }}
          mockUserAppScopes: ${{ steps.keyVaultSecrets.outputs.AzureAdClientIdScope }}
          keyVaultUserClientId: ${{ secrets.AZURE_KEYVAULT_DEV_NAME }}
          keyVaultName: ${{ secrets.AZURE_KEYVAULT_DEV_NAME }}
          cypressAccesstokenSecretname: 'cypressAccesstokenDev'
          NUGET_PACKAGES: $(Pipeline.Workspace)/.nuget
          NPM_PACKAGES: $(Pipeline.Workspace)/.npm
          CYPRESS_BINARY: $(Pipeline.Workspace)/.cypressbinary
          clientId: ${{ secrets.DEV_AZURE_CREDENTIALS_CLIENT_ID }}
          clientSecret:  ${{ secrets.DEV_AZURE_CREDENTIALS_CLIENT_SECRET }}
          tenantId: ${{ secrets.AZURE_TENANT_ID }}
          azureSubscriptionId: ${{ secrets.DEV_AZURE_SUBSCRIPTION_ID }}
        run: |
          dotnet GetAccessToken/bin/Release/netcoreapp3.1/GetAccessToken.dll --tenant-id $tenantId --app-id $mockuserAppId --mock-user-client-secret $mockappuserClientSecret --authority $mockUserAppScopes --key-vault-name $keyVaultName --key-vault-secret-name $cypressAccesstokenSecretname --key-vault-user-client-secret $clientSecret --key-vault-user-client-id $clientId

      - uses: Azure/get-keyvault-secrets@v1
        with:
          keyvault: ${{ secrets.AZURE_KEYVAULT_DEV_NAME }}
          secrets: 'cypressAccesstokenDev'  # comma separated list of secret keys that need to be fetched from the Key Vault 
        id: token

      # Install Node dependencies --spec "cypress/integration/test/test.spec.js"
      - run: npm ci

      - run: npm install --save-dev mocha mochawesome mochawesome-merge mochawesome-report-generator
#$token
      - run: npx cypress run --config-file "cypress.dev.json" --env cyAccessToken="eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsImtpZCI6Im5PbzNaRHJPRFhFSzFqS1doWHNsSFJfS1hFZyJ9.eyJhdWQiOiJlOTBjYmI2MS04OTZlLTRlYzctYWEzNy0yMzUxMTcwMGUxZWQiLCJpc3MiOiJodHRwczovL2xvZ2luLm1pY3Jvc29mdG9ubGluZS5jb20vM2FhNGEyMzUtYjZlMi00OGQ1LTkxOTUtN2ZjZjA1YjQ1OWIwL3YyLjAiLCJpYXQiOjE2MjA3MjI0NzgsIm5iZiI6MTYyMDcyMjQ3OCwiZXhwIjoxNjIwNzI2Mzc4LCJhaW8iOiJBVFFBeS84VEFBQUFHZ1RUYWFYWTdHTWdCWUIzVWI0Vm5WR0UwTHh3QktBUkx4MG1qdmtWUjBuNjQ0Wi9uRDJ0eWxHTVhIeTQxR3dWIiwiYXpwIjoiZTkwY2JiNjEtODk2ZS00ZWM3LWFhMzctMjM1MTE3MDBlMWVkIiwiYXpwYWNyIjoiMCIsImVtYWlsIjoiSEFOT0xAZXF1aW5vci5jb20iLCJuYW1lIjoiSGFucyBLcmlzdGlhbiBWaWsgT2xzZW4iLCJvaWQiOiI3NjIxMDZlZS04YmRhLTQyYjQtOGQ4YS01MzdiMDdiY2FiMDEiLCJwcmVmZXJyZWRfdXNlcm5hbWUiOiJIQU5PTEBlcXVpbm9yLmNvbSIsInJoIjoiMC5BUUlBTmFLa091SzIxVWlSbFhfUEJiUlpzR0c3RE9sdWljZE9xamNqVVJjQTRlMENBSTguIiwicm9sZXMiOlsiU2VwZXMtU3BvbnNvciIsIlNlcGVzLUFkbWluIiwiU2VwZXMtRW1wbG95ZWUiXSwic2NwIjoiVXNlci5SZWFkIFVzZXIuUmVhZC5BbGwgVXNlci5JbXBlcnNvbmF0aW9uIiwic3ViIjoiOWdGVVZKRlI3WlkwWmxxQ2R5Wk1hZ0pWY3l1WWNfMVJUa2h4QVVCNUsxSSIsInRpZCI6IjNhYTRhMjM1LWI2ZTItNDhkNS05MTk1LTdmY2YwNWI0NTliMCIsInVwbiI6IkhBTk9MQGVxdWlub3IuY29tIiwidXRpIjoidmZZTEhXaWVVa2FWemRtRG5fWlJBQSIsInZlciI6IjIuMCJ9.YUqSvjS58F91WLUt8Ws8QviDZEmb9vgQ3fc_NFh87x2y-tB3--_bR7x-GN83XomyifVHtzbXZUDbl2HVcWBXAn-CZy-VSzkhU7MW3kS_QluuOUEPsXnza4NldGrgJ4ZjvH5vVWSEBTVD85Hd8bji54uFIp3W7APEcOLZgfiiDsBZKyelmCkwIU2zynBWmpikJiFe91LDFHvfMh5YhPLJFTREO5188csW1OJ4JmdZnSjVvMk1j2W9LCcrkX32An4gPz436z-v0eEkiy7JE8j9ljjUKxeNRSJJIbfqv0Pt5SsZVJCaKAJQDosgnUfnvVwH7YPX7zkBQ4le1MIcc_3mpg"

